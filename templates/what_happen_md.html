<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>See we're doing things</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='custom.css') }}">
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
</head>
<body>
<div id="everything">

    <div id="textarea">
        <textarea id="what_happen_text">
            {{ text }}
        </textarea>
    </div>

    <div id="preview">
        {{ text|markdown }}
    </div>

    <div class="clear"></div>
</div>

<script type="text/javascript">
    var change_count = 0;
    var isConnected = false;
    var isDirty = false;
    var oldTime = new Date().getTime();
    var sentData = false;

    // on page load connect to websocket
    var socket = io.connect('http://' + document.domain + ':' + location.port);
    socket.on('connect', function() {
        isConnected = true;
    });


    var area = document.querySelector('textarea#what_happen_text');
    if (area.addEventListener) {
        area.addEventListener('input', function() {

            if (!isDirty) {
                isDirty = true;
                oldTime = new Date().getTime();
            }

            change_count = change_count + 1;
            console.log(change_count);
            var timeDiff = new Date().getTime() - oldTime;
            var todo = document.getElementById("what_happen_text").value;
            if (change_count == 20) {
                console.log('SENDING SOMETHING!', isConnected, change_count, timeDiff);
                send_md(todo);
                change_count = 0;
                oldTime = new Date().getTime();
                sentData = true;
            }

        }, false);
    } else if (area.attachEvent) {

        area.attachEvent('onpropertychange', function() {
            // IE-specific event handling code
        });
    }

    setInterval(function() {
        if (!sentData && isDirty) {
            // todo: what happens after first call dirty-ing isdirty?
            var todo = document.getElementById("what_happen_text").value;
            send_md(todo);
        }
    }, 10000);

    function send_md(todo) {
        if (isConnected) {
            socket.emit('md change', todo);
        }
    }

</script>
</body>
</html>