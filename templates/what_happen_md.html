<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>See we're doing things</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='custom.css') }}">
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
</head>
<body>
<div id="everything">

    <div id="textarea">
        <textarea id="what_happen_text">
            {{ text }}
        </textarea>
    </div>

    <div id="preview">
        {{ text|markdown }}
    </div>

    <div class="clear"></div>
</div>

<script type="text/javascript">
    var change_count = 0;

    // on page load connect to websocket
    var socket = io.connect('http://' + document.domain + ':' + location.port);
    socket.on('connect', function() {
        console.log('connected');
    });

    var area = document.querySelector('textarea#what_happen_text');

    if (area.addEventListener) {
        area.addEventListener('input', function() {
            change_count++;
            console.log(change_count);
            var todo = document.getElementById("what_happen_text").value;
            // TODO: or timeout happens
            if (change_count == 10) {
                // TODO: check for if connected
                socket.emit('md change', {data: todo});
                change_count = 0;
            }

        }, false);
    } else if (area.attachEvent) {

        area.attachEvent('onpropertychange', function() {
            // IE-specific event handling code
        });
    }


</script>
</body>
</html>