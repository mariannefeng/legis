<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>See we're doing things</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='custom.css') }}">
    <script type=text/javascript src="{{ url_for('static', filename='jquery.js') }}"></script>
</head>

<script type=text/javascript>
    $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
</script>

<body>
<div id="everything">

    <div id="textarea">
        <textarea id="what_happen_text">
            {{ text }}
        </textarea>
    </div>

    <div id="preview">
        {{ text|markdown }}
    </div>

    <div class="clear"></div>
</div>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/showdown/1.6.4/showdown.min.js"></script>
<script type="text/javascript">
    var change_count = 0;
//    var isConnected = false;
    var isDirty = false;
    var sentData = false;

    // on page load connect to websocket
//    var socket = io.connect('http://' + document.domain + ':' + location.port);
//    socket.on('connect', function() {
//        isConnected = true;
//    });


    var area = document.querySelector('textarea#what_happen_text');
    if (area.addEventListener) {
        area.addEventListener('input', function() {

            if (!isDirty) {
                isDirty = true;
                oldTime = new Date().getTime();
            }

            change_count = change_count + 1;
            console.log(change_count);
            var todo = document.getElementById("what_happen_text").value;
            if (change_count == 15) {
                send_md(todo);
                change_count = 0;
                oldTime = new Date().getTime();
                sentData = true;
            }

        }, false);
    } else if (area.attachEvent) {
        area.attachEvent('onpropertychange', function() {
            // IE-specific event handling code
        });
    }

    setInterval(function() {
        if (!sentData && isDirty) {
            // todo: what happens after first call dirty-ing isdirty?
            var todo = document.getElementById("what_happen_text").value;
            send_md(todo);
        }
    }, 10000);

    function send_md(todo) {
        $.ajax({
            type : "POST",
            url : $SCRIPT_ROOT + '/md_change',
            data: todo,
            contentType: 'text;charset=UTF-8',
            success: function(result) {

//                console.log(micromarkdown.parse(result))
//                var input = document.getElementById('what_happen_text').value;
//                console.log('input', input)
//                var preview = document.getElementById('preview');
//                preview.innerHTML = micromarkdown.parse(input);
//                var test = $('#what_happen_text').html().replace(/\n/g, "\\n")


                var converter = new showdown.Converter(),
                    text      = $('#what_happen_text').val(),
                    html      = converter.makeHtml(text);
//                console.log(test);
                $('#preview').html(html);
                sendData = false;
            }
        });
//        if (isConnected) {
//            socket.emit('md change', todo);
//        }
    }

</script>
</body>
</html>